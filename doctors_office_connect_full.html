<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doctor's Office Connect â€” Full Classroom Edition</title>
<style>
  :root{
    --bg:#f6f9ff; --card:#fff; --accent:#0366d6; --muted:#6b7280; --good:#16a34a; --bad:#dc2626;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; color:#0f172a;
  }
  body{margin:0;background:var(--bg);padding:18px;display:flex;justify-content:center;}
  .wrap{width:100%;max-width:1100px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#2dd4bf,#0366d6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(11,15,30,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e6eefc}
  button{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  button.secondary{background:#eef2ff;color:var(--accent);border:1px solid #cfe4ff}
  .prompt{font-size:16px;margin:10px 0}
  .options{display:flex;flex-direction:column;gap:8px}
  .opt{padding:10px;border-radius:8px;border:1px solid #e6eefc;background:#fbfdff;cursor:pointer;text-align:left}
  .opt:hover{box-shadow:0 6px 18px rgba(3,102,214,0.08)}
  .meta{font-size:13px;color:var(--muted)}
  #feedback{margin-top:10px;font-weight:700}
  #scoreboard{font-weight:700;margin-bottom:8px}
  .log{height:150px;overflow:auto;padding:8px;border-radius:8px;background:#fbfdff;border:1px dashed #e6eefc}
  .small{font-size:13px;color:var(--muted)}
  .recordBtn{background:#10b981}
  .danger{background:#ef4444}
  .teacher-panel h3{margin-top:0}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid #f1f5f9;font-size:13px;text-align:left}
  .center{text-align:center}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:var(--accent);font-weight:600}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">DOC</div>
    <div>
      <h1>Doctor's Office Connect â€” Full Classroom Edition</h1>
      <div class="small">Branching game â€¢ Recording â€¢ Dashboard â€¢ Certificates â€¢ Multi-level â€¢ Spanish/English</div>
    </div>
    <div style="margin-left:auto" class="small">Teacher: Edward O. Oyugi</div>
  </header>

  <div class="grid">
    <!-- Left: Game -->
    <section class="card" aria-label="Game area">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="scoreboard">Score: <span id="score">0</span></div>
          <div class="meta">Round <span id="roundNum">1</span> â€¢ Step <span id="stepNum">1</span> / <span id="stepsPerRound">4</span></div>
        </div>
        <div class="controls">
          <label class="small">Level</label>
          <select id="levelSelect">
            <option value="beginner">Beginner</option>
            <option value="intermediate" selected>Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
          <label class="small">Lang</label>
          <select id="langSelect">
            <option value="en" selected>English</option>
            <option value="es">EspaÃ±ol</option>
          </select>
        </div>
      </div>

      <hr/>

      <div style="display:flex;gap:12px;align-items:center">
        <input id="studentName" type="text" placeholder="Student name (First Last)" style="flex:1" />
        <button id="startBtn">Start</button>
      </div>

      <div style="margin-top:12px">
        <div id="receptionistArea" style="display:flex;gap:12px;align-items:center">
          <div style="width:72px;height:72px;border-radius:10px;background:linear-gradient(135deg,#60a5fa,#7c3aed);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px" id="avatar">R</div>
          <div>
            <div id="promptText" class="prompt">Press Start to demo the first prompt.</div>
            <div id="audioToggleWrap" class="small"><button id="speakToggle" class="secondary">Audio: On</button></div>
          </div>
        </div>

        <div id="options" class="options" style="margin-top:12px"></div>

        <div id="feedback" class="meta"></div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="hintBtn" class="secondary">Hint</button>
          <button id="nextBtn" class="secondary" disabled>Next</button>
          <div style="margin-left:auto" class="small">Progress <span id="progressPct">0%</span></div>
        </div>
      </div>

      <!-- Recording -->
      <div style="margin-top:14px;border-top:1px dashed #e6eefc;padding-top:12px">
        <div class="meta">Pronunciation & Recording</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <button id="recordBtn" class="recordBtn">ðŸŽ¤ Start Recording</button>
          <button id="playBtn" class="secondary" disabled>â–¶ Play</button>
          <button id="downloadBtn" class="secondary" disabled>â¬‡ Download</button>
          <div style="margin-left:auto" class="small">Auto-score: <span id="autoScore">â€”</span></div>
        </div>
        <audio id="audioPlayer" controls style="width:100%;margin-top:8px;display:none"></audio>
      </div>
    </section>

    <!-- Right: Teacher Dashboard -->
    <aside class="card teacher-panel" aria-label="Teacher dashboard">
      <h3>Teacher Dashboard</h3>
      <div class="meta">Saved attempts (local)</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="refreshBtn" class="secondary">Refresh</button>
        <button id="exportCsvBtn">Export CSV</button>
        <button id="clearBtn" class="danger">Clear All</button>
      </div>

      <div style="margin-top:10px">
        <table id="attemptsTable" aria-label="Attempts table">
          <thead><tr><th>Student</th><th>Score</th><th>Level</th><th>Time</th><th class="center">Actions</th></tr></thead>
          <tbody id="attemptsBody"></tbody>
        </table>
      </div>

      <hr/>
      <div class="meta">Certificate / Slip</div>
      <div style="margin-top:8px">
        <button id="certBtn">Create Certificate (PNG)</button>
        <button id="slipBtn" class="secondary">Print Confirmation Slip</button>
      </div>

      <hr/>
      <div class="meta">Pronunciation scoring</div>
      <p class="small">When available, the browser's SpeechRecognition transcribes student speech and we compute a simple word-similarity score vs the target sentence. This helps give quick feedback. If unavailable, teachers can play the audio and grade manually.</p>
    </aside>
  </div>

  <footer>
    <div class="small">Works offline after hosting. For long-term storage use LMS upload/export. SpeechRecognition support varies by browser (Chrome desktop recommended).</div>
  </footer>
</div>

<script>
/* =========================
   Doctor's Office Connect - Full
   Features implemented:
   - Branching game (5 rounds, 4 steps each)
   - Student name & saved attempts (localStorage)
   - Recording + playback + download
   - Automatic pronunciation scoring using Web Speech API (if available)
   - Teacher dashboard to view attempts, export CSV, clear
   - Certificate generation (Canvas) & printable confirmation slip
   - ESL levels & Spanish support (simple translations)
   ========================= */

/* ---------- Configuration & Scripted Rounds (branching) ---------- */
/* For brevity includes 5 rounds with 4 steps. Each step has options with correctness and hints. */

const ROUNDS = [
  // Round 1
  { id:'r1', patient:'Mr. Ali', steps:[
    { id:'greet', text_en:"Receptionist: Thank you for calling Family Medical Clinic. How can I help you?", text_es:"RecepciÃ³n: Gracias por llamar a Family Medical Clinic. Â¿En quÃ© puedo ayudarle?",
      options:[
        {text_en:"I need appointment.", text_es:"Necesito una cita.", correct:false, hint_en:"Use a polite opening sentence.", hint_es:"Use una frase de apertura mÃ¡s cortÃ©s."},
        {text_en:"Hello, I'd like to make an appointment, please.", text_es:"Hola, quisiera hacer una cita, por favor.", correct:true},
        {text_en:"What is your name?", text_es:"Â¿CuÃ¡l es su nombre?", correct:false, hint_en:"Receptionist asks this later.", hint_es:"La recepcionista pregunta esto mÃ¡s tarde."}
      ]
    },
    { id:'symptom', text_en:"Receptionist: What seems to be the problem?", text_es:"Â¿CuÃ¡l es el problema?",
      options:[
        {text_en:"I have a fever and sore throat.", text_es:"Tengo fiebre y dolor de garganta.", correct:true},
        {text_en:"Maybe later.", text_es:"QuizÃ¡ mÃ¡s tarde.", correct:false, hint_en:"Provide a symptom.", hint_es:"Proporcione un sÃ­ntoma."}
      ]
    },
    { id:'schedule', text_en:"Receptionist: We have Tuesday morning or Thursday afternoon. Which works?", text_es:"Tenemos martes por la maÃ±ana o jueves por la tarde. Â¿CuÃ¡l le sirve?",
      options:[
        {text_en:"Thursday afternoon works.", text_es:"El jueves por la tarde estÃ¡ bien.", correct:true},
        {text_en:"I don't want to go.", text_es:"No quiero ir.", correct:false, hint_en:"Select a time.", hint_es:"Seleccione un horario."}
      ]
    },
    { id:'confirm', text_en:"Receptionist: Please spell your last name and provide DOB and insurance (if any).", text_es:"Por favor deletree su apellido y proporcione fecha de nacimiento y seguro (si tiene).",
      options:[
        {text_en:"My name is Ali. DOB 05/12/1984. No insurance.", text_es:"Mi nombre es Ali. Fecha de nacimiento 05/12/1984. Sin seguro.", correct:true},
        {text_en:"Yes yes.", text_es:"SÃ­ sÃ­.", correct:false, hint_en:"Give full details.", hint_es:"DÃ© detalles completos."}
      ]
    }
  ]},

  // Round 2
  { id:'r2', patient:'Ms. Rivera', steps:[
    { id:'greet', text_en:"Hello, this is Sunrise Clinic. How can I help you?", text_es:"Hola, habla Sunrise Clinic. Â¿En quÃ© puedo ayudarle?",
      options:[
        {text_en:"I'd like to book a check-up, please.", text_es:"Quisiera pedir un chequeo, por favor.", correct:true},
        {text_en:"Where are you located?", text_es:"Â¿DÃ³nde estÃ¡n ubicados?", correct:false, hint_en:"State your purpose first.", hint_es:"Diga su propÃ³sito primero."}
      ]
    },
    { id:'symptom', text_en:"Do you have symptoms or is this routine?", text_es:"Â¿Tiene sÃ­ntomas o es una visita de rutina?",
      options:[
        {text_en:"I have stomach pain since yesterday.", text_es:"Tengo dolor de estÃ³mago desde ayer.", correct:true},
        {text_en:"I'm fine.", text_es:"Estoy bien.", correct:false, hint_en:"If fine, say 'routine check'.", hint_es:"Si estÃ¡ bien, diga 'visita de rutina'."}
      ]
    },
    { id:'schedule', text_en:"We can do tomorrow morning or Friday afternoon. Which?", text_es:"Podemos maÃ±ana en la maÃ±ana o viernes por la tarde. Â¿CuÃ¡l?",
      options:[
        {text_en:"Tomorrow morning, please.", text_es:"MaÃ±ana por la maÃ±ana, por favor.", correct:true},
        {text_en:"Pick for me.", text_es:"Elija por mÃ­.", correct:false, hint_en:"Choose yourself.", hint_es:"Elija usted mismo."}
      ]
    },
    { id:'confirm', text_en:"Please confirm your name and phone number.", text_es:"Confirme su nombre y nÃºmero de telÃ©fono.",
      options:[
        {text_en:"Yes: Maria Rivera, 555-0142.", text_es:"SÃ­: Maria Rivera, 555-0142.", correct:true},
        {text_en:"Maybe later.", text_es:"QuizÃ¡ mÃ¡s tarde.", correct:false, hint_en:"Provide contact information.", hint_es:"Proporcione informaciÃ³n de contacto."}
      ]
    }
  ]},

  // Round 3
  { id:'r3', patient:'Mr. Chen', steps:[
    { id:'greet', text_en:"Family Health Line. How may I assist you today?", text_es:"Family Health Line. Â¿CÃ³mo puedo ayudarle hoy?",
      options:[
        {text_en:"I'd like to schedule for a cough.", text_es:"Quisiera programar por una tos.", correct:true},
        {text_en:"Who is the doctor?", text_es:"Â¿QuiÃ©n es el doctor?", correct:false, hint_en:"Give reason first.", hint_es:"DÃ© la razÃ³n primero."}
      ]
    },
    { id:'symptom', text_en:"How long have you had the cough?", text_es:"Â¿CuÃ¡nto tiempo ha tenido la tos?",
      options:[
        {text_en:"Three days.", text_es:"Tres dÃ­as.", correct:true},
        {text_en:"I cough sometimes.", text_es:"Toso a veces.", correct:false, hint_en:"Be specific with duration.", hint_es:"Sea especÃ­fico con la duraciÃ³n."}
      ]
    },
    { id:'schedule', text_en:"We have 10:00 tomorrow or 6pm evening. Which?", text_es:"Tenemos 10:00 maÃ±ana o 6pm en la noche. Â¿CuÃ¡l?",
      options:[
        {text_en:"10:00 tomorrow works for me.", text_es:"10:00 maÃ±ana me va bien.", correct:true},
        {text_en:"I will think about it.", text_es:"Lo pensarÃ©.", correct:false, hint_en:"Pick a slot now to book.", hint_es:"Elija una franja ahora para reservar."}
      ]
    },
    { id:'confirm', text_en:"Provide your insurance provider and a preferred contact number.", text_es:"Proporcione su aseguradora y un nÃºmero de contacto preferido.",
      options:[
        {text_en:"UnitedCare. Phone: 555-0123.", text_es:"UnitedCare. Tel: 555-0123.", correct:true},
        {text_en:"I don't know.", text_es:"No sÃ©.", correct:false, hint_en:"Try to provide a phone.", hint_es:"Intente dar un telÃ©fono."}
      ]
    }
  ]},

  // Round 4
  { id:'r4', patient:'Mrs. Patel', steps:[
    { id:'greet', text_en:"Good afternoon. City Clinic, how can I assist?", text_es:"Buenas tardes. City Clinic, Â¿en quÃ© puedo asistir?",
      options:[
        {text_en:"I'd like to make an appointment for my child.", text_es:"Quisiera una cita para mi hijo.", correct:true},
        {text_en:"What's the address?", text_es:"Â¿CuÃ¡l es la direcciÃ³n?", correct:false, hint_en:"State purpose first.", hint_es:"Diga el propÃ³sito primero."}
      ]
    },
    { id:'symptom', text_en:"Is this an emergency or routine?", text_es:"Â¿Es una emergencia o rutina?",
      options:[
        {text_en:"Routine; my child has a fever.", text_es:"Rutina; mi hijo tiene fiebre.", correct:true},
        {text_en:"Emergency!", text_es:"Â¡Emergencia!", correct:false, hint_en:"If emergency, call 911/come in.", hint_es:"Si es emergencia, llame al 911/venir de inmediato."}
      ]
    },
    { id:'schedule', text_en:"Family slot Saturday morning or next Monday. Which?", text_es:"Franja familiar sÃ¡bado por la maÃ±ana o el prÃ³ximo lunes. Â¿CuÃ¡l?",
      options:[
        {text_en:"Saturday morning, please.", text_es:"SÃ¡bado por la maÃ±ana, por favor.", correct:true},
        {text_en:"I don't want.", text_es:"No quiero.", correct:false, hint_en:"Pick one option.", hint_es:"Elija una opciÃ³n."}
      ]
    },
    { id:'confirm', text_en:"Please provide child's name and contact number.", text_es:"Proporcione el nombre del niÃ±o y nÃºmero de contacto.",
      options:[
        {text_en:"Asha Patel. Phone: 555-0987.", text_es:"Asha Patel. Tel: 555-0987.", correct:true},
        {text_en:"Maybe.", text_es:"QuizÃ¡.", correct:false, hint_en:"Provide info.", hint_es:"Proporcione la informaciÃ³n."}
      ]
    }
  ]},

  // Round 5
  { id:'r5', patient:'Mr. Gomez', steps:[
    { id:'greet', text_en:"Hello, Lakeside Health. How can I help?", text_es:"Hola, Lakeside Health. Â¿CÃ³mo puedo ayudarle?",
      options:[
        {text_en:"My back hurts after moving furniture.", text_es:"Me duele la espalda tras mover muebles.", correct:true},
        {text_en:"Do you have doctors?", text_es:"Â¿Tienen doctores?", correct:false, hint_en:"Give reason first.", hint_es:"De la razÃ³n primero."}
      ]
    },
    { id:'symptom', text_en:"How did it happen and how long?", text_es:"Â¿CÃ³mo pasÃ³ y cuÃ¡nto tiempo hace?",
      options:[
        {text_en:"Moved furniture last weekend; pain started two days ago.", text_es:"MovÃ­ muebles el fin de semana; dolor desde hace dos dÃ­as.", correct:true},
        {text_en:"I have pain.", text_es:"Tengo dolor.", correct:false, hint_en:"Add timeframe or cause.", hint_es:"Agregue tiempo o causa."}
      ]
    },
    { id:'schedule', text_en:"We have Wednesday 2pm or Friday morning. Which?", text_es:"Tenemos miÃ©rcoles 2pm o viernes en la maÃ±ana. Â¿CuÃ¡l?",
      options:[
        {text_en:"Friday morning works.", text_es:"Viernes por la maÃ±ana funciona.", correct:true},
        {text_en:"Any time is fine.", text_es:"Cualquier hora estÃ¡ bien.", correct:false, hint_en:"Pick one of the offered options.", hint_es:"Elija una de las opciones ofrecidas."}
      ]
    },
    { id:'confirm', text_en:"Confirm your full name and phone number.", text_es:"Confirme su nombre completo y telÃ©fono.",
      options:[
        {text_en:"Rafael Gomez, 555-0220.", text_es:"Rafael Gomez, 555-0220.", correct:true},
        {text_en:"Not sure.", text_es:"No estoy seguro.", correct:false, hint_en:"Provide contact info.", hint_es:"Proporcione info de contacto."}
      ]
    }
  ]}
];

// Game settings
const STEPS_PER_ROUND = 4;
const POINTS_PER_CORRECT = 10;

/* ---------- App State ---------- */
let state = {
  roundIndex: 0,
  stepIndex: 0,
  score: 0,
  studentName: '',
  level: 'intermediate',
  lang: 'en',
  recordingBlob: null,
  attemptsKey: 'doc_game_attempts_v1'
};

/* ---------- DOM ---------- */
const startBtn = document.getElementById('startBtn');
const promptText = document.getElementById('promptText');
const optionsDiv = document.getElementById('options');
const feedback = document.getElementById('feedback');
const scoreEl = document.getElementById('score');
const roundNum = document.getElementById('roundNum');
const stepNum = document.getElementById('stepNum');
const stepsPerRoundEl = document.getElementById('stepsPerRound');
const progressPct = document.getElementById('progressPct');
const recordBtn = document.getElementById('recordBtn');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const audioPlayer = document.getElementById('audioPlayer');
const audioToggle = document.getElementById('speakToggle');
const levelSelect = document.getElementById('levelSelect');
const langSelect = document.getElementById('langSelect');
const studentNameInput = document.getElementById('studentName');

const attemptsBody = document.getElementById('attemptsBody');
const refreshBtn = document.getElementById('refreshBtn');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const clearBtn = document.getElementById('clearBtn');

const certBtn = document.getElementById('certBtn');
const slipBtn = document.getElementById('slipBtn');
const hintBtn = document.getElementById('hintBtn');
const nextBtn = document.getElementById('nextBtn');
const avatar = document.getElementById('avatar');
const roundSteps = STEPS_PER_ROUND;

/* ---------- Helpers ---------- */
function t(strObj){
  // strObj has text_en and text_es OR text_en only
  if(!strObj) return '';
  if(state.lang === 'es'){
    return strObj.text_es || strObj.text_en || '';
  }
  return strObj.text_en || '';
}
function pickText(opt){
  return state.lang === 'es' ? (opt.text_es||opt.text_en) : (opt.text_en||opt.text_es);
}
function pickHint(opt){
  return state.lang === 'es' ? (opt.hint_es||opt.hint_en||'') : (opt.hint_en||opt.hint_es||'');
}
function speak(text){
  if(!speakEnabled) return;
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = state.lang === 'es' ? 'es-ES' : 'en-US';
    u.rate = 0.98;
    window.speechSynthesis.speak(u);
  }
}
function updateUI(){
  scoreEl.textContent = state.score;
  roundNum.textContent = state.roundIndex+1;
  stepNum.textContent = state.stepIndex+1;
  stepsPerRoundEl.textContent = STEPS_PER_ROUND;
  const completed = (state.roundIndex*STEPS_PER_ROUND + state.stepIndex);
  const total = ROUNDS.length * STEPS_PER_ROUND;
  progressPct.textContent = Math.round((completed/total)*100) + '%';
}
function resetGameForStudent(){
  state.roundIndex = 0; state.stepIndex = 0; state.score = 0; state.recordingBlob = null;
  updateUI();
  audioPlayer.style.display = 'none';
  playBtn.disabled = true; downloadBtn.disabled = true;
  renderStep();
}
function getCurrentStepObj(){
  return ROUNDS[state.roundIndex].steps[state.stepIndex];
}

/* ---------- Rendering & Interaction ---------- */
let speakEnabled = true;
audioToggle.addEventListener('click', ()=>{
  speakEnabled = !speakEnabled;
  audioToggle.textContent = speakEnabled ? 'Audio: On' : 'Audio: Off';
});

levelSelect.addEventListener('change', ()=> state.level = levelSelect.value);
langSelect.addEventListener('change', ()=> { state.lang = langSelect.value; renderStep(); });

startBtn.addEventListener('click', ()=>{
  const name = studentNameInput.value.trim();
  if(!name){
    alert('Please enter student name.');
    return;
  }
  state.studentName = name;
  resetGameForStudent();
});

function renderStep(){
  const stepObj = getCurrentStepObj();
  const prompt = state.lang === 'es' ? stepObj.text_es || stepObj.text_en : stepObj.text_en;
  promptText.textContent = prompt;
  avatar.textContent = ROUNDS[state.roundIndex].patient.charAt(0) || 'R';
  optionsDiv.innerHTML = '';
  feedback.textContent = '';
  nextBtn.disabled = true;
  // adapt options by level: beginner shows simpler synonyms (not implemented complexly here)
  stepObj.options.forEach((opt, idx)=>{
    // choose option text according to language
    const text = pickText(opt);
    const btn = document.createElement('div');
    btn.className = 'opt';
    btn.tabIndex = 0;
    btn.textContent = text;
    btn.addEventListener('click', ()=> handleChoice(opt));
    btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleChoice(opt); });
    optionsDiv.appendChild(btn);
  });
  speak(prompt);
  updateUI();
}

function handleChoice(option){
  // Check correctness
  if(option.correct){
    state.score += POINTS_PER_CORRECT;
    feedback.style.color = 'var(--good)';
    feedback.textContent = state.lang === 'es' ? 'Correcto âœ…' : 'Correct âœ…';
    // move to next step
    nextBtn.disabled = false;
    // save partial progress to log
    logEvent(`${state.studentName}: Correct choice at R${state.roundIndex+1} S${state.stepIndex+1}`);
  } else {
    feedback.style.color = 'var(--bad)';
    const hint = pickHint(option) || (state.lang==='es' ? 'Intenta de nuevo.' : 'Try again.');
    feedback.textContent = (state.lang==='es' ? 'No exactamente âŒ ' : 'Not quite âŒ ') + hint;
    // small encouragement, allow retry; no penalty to score here
    logEvent(`${state.studentName}: Incorrect choice at R${state.roundIndex+1} S${state.stepIndex+1}`);
  }
  scoreEl.textContent = state.score;
}

/* Next step handler */
nextBtn.addEventListener('click', ()=>{
  state.stepIndex++;
  if(state.stepIndex >= STEPS_PER_ROUND){
    state.stepIndex = 0;
    state.roundIndex++;
    if(state.roundIndex >= ROUNDS.length){
      // game complete
      finishAttempt();
      return;
    }
  }
  renderStep();
});

/* hint handler */
hintBtn.addEventListener('click', ()=>{
  const stepObj = getCurrentStepObj();
  // show first hint from options or generic
  const hint = stepObj.options.find(o=>o.hint_en || o.hint_en) || {};
  const text = pickHint(hint) || (state.lang==='es' ? 'Use una frase mÃ¡s cortÃ©s y completa.' : 'Use a polite, complete sentence.');
  feedback.style.color = '#b45309';
  feedback.textContent = (state.lang==='es' ? 'Pista: ' : 'Hint: ') + text;
  logEvent(`${state.studentName}: Hint shown at R${state.roundIndex+1} S${state.stepIndex+1}`);
});

/* ---------- Recording (MediaRecorder) ---------- */
let mediaRecorder = null;
let audioChunks = [];
recordBtn.addEventListener('click', async ()=>{
  if(!state.studentName){ alert('Enter student name first.'); return; }
  if(!mediaRecorder || mediaRecorder.state === 'inactive'){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async ()=>{
        const blob = new Blob(audioChunks, { type:'audio/webm' });
        state.recordingBlob = blob;
        audioPlayer.src = URL.createObjectURL(blob);
        audioPlayer.style.display = 'block';
        playBtn.disabled = false; downloadBtn.disabled = false;
        // Auto-score using SpeechRecognition if available
        await autoScorePronunciation(blob);
      };
      mediaRecorder.start();
      recordBtn.textContent = state.lang==='es' ? 'â¹ Detener grabaciÃ³n' : 'â¹ Stop Recording';
      logEvent(`${state.studentName}: Started recording`);
    }catch(err){
      alert('Microphone access denied or not available.');
    }
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = state.lang==='es' ? 'ðŸŽ¤ Grabar' : 'ðŸŽ¤ Record';
    logEvent(`${state.studentName}: Stopped recording`);
  }
});

playBtn.addEventListener('click', ()=> {
  if(state.recordingBlob) audioPlayer.play();
});

downloadBtn.addEventListener('click', ()=>{
  if(!state.recordingBlob) return;
  const url = URL.createObjectURL(state.recordingBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${state.studentName.replace(/\s+/g,'_')}_appointment_audio.webm`;
  a.click();
});

/* ---------- Auto Pronunciation Scoring (uses SpeechRecognition fallback) ---------- */
async function autoScorePronunciation(blob){
  // Try Web Speech API first (SpeechRecognition). This API transcribes live mic, but not blob;
  // So as a fallback use offline approximate method: ask user to speak and we transcribe live if supported.
  // Simpler approach: open recognition for a short live capture and compare to target.
  const target = "I would like to make a doctor's appointment, please.";
  const target_es = "Quisiera hacer una cita con el mÃ©dico, por favor.";
  const target_text = state.lang==='es' ? target_es : target;

  const supportsRecognition = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
  if(!supportsRecognition){
    document.getElementById('autoScore').textContent = 'N/A';
    logEvent('Auto-score not available in this browser.');
    return;
  }

  // Try transient live recognition to transcribe â€” prompt the user to speak again for scoring if necessary
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = new SpeechRecognition();
  recog.lang = state.lang==='es' ? 'es-ES' : 'en-US';
  recog.interimResults = false;
  recog.maxAlternatives = 1;

  return new Promise((resolve)=>{
    recog.onresult = (ev)=>{
      const transcript = ev.results[0][0].transcript;
      const score = wordSimilarityScore(transcript, target_text);
      document.getElementById('autoScore').textContent = score + '%';
      logEvent(`${state.studentName}: Auto-score ${score}% (transcript: ${transcript})`);
      // Save attempt with score
      saveAttempt({ score: state.score, autoScore: score });
      recog.stop();
      resolve(score);
    };
    recog.onerror = (err)=>{
      document.getElementById('autoScore').textContent = 'Err';
      logEvent('SpeechRecognition error: '+ err.message);
      resolve(null);
    };
    // Ask user to speak briefly now
    alert((state.lang==='es' ? 'Para la puntuaciÃ³n automÃ¡tica, vuelva a decir la frase ahora en voz alta.' : 'For automatic scoring, please say the target sentence aloud now.'));
    recog.start();
  });
}

/* Simple word-similarity: compare words using Levenshtein and compute percent */
function levenshtein(a,b){
  const m=a.length, n=b.length;
  if(m===0) return n; if(n===0) return m;
  const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
function wordSimilarityScore(a,b){
  // normalize
  const na = a.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ±Ã¼ÃŸ0-9\s]/gi,'').trim();
  const nb = b.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ±Ã¼ÃŸ0-9\s]/gi,'').trim();
  if(!na || !nb) return 0;
  const wa = na.split(/\s+/);
  const wb = nb.split(/\s+/);
  // match each word in target to nearest in transcript
  let totalScore=0;
  for(const targetWord of wb){
    let best=Infinity;
    for(const tw of wa){
      const d = levenshtein(targetWord, tw);
      best = Math.min(best, d);
    }
    // word score = 1 - (dist / maxLen)
    const maxLen = Math.max(targetWord.length,1);
    const wscore = Math.max(0, 1 - (best/maxLen));
    totalScore += wscore;
  }
  const percent = Math.round((totalScore / wb.length) * 100);
  return percent;
}

/* ---------- Finish & Save Attempt ---------- */
function finishAttempt(){
  // save attempt data to localStorage
  const attempt = {
    student: state.studentName,
    score: state.score,
    level: state.level,
    lang: state.lang,
    timestamp: new Date().toISOString(),
    roundsCompleted: state.roundIndex,
    autoScore: document.getElementById('autoScore').textContent || '',
    recording: null
  };
  if(state.recordingBlob){
    // convert blob to base64 for storage (warning: large)
    const reader = new FileReader();
    reader.onload = function(){ 
      attempt.recording = reader.result; // base64
      pushAttempt(attempt);
      alert((state.lang==='es'?'Juego completo â€” intento guardado.':'Game complete â€” attempt saved.'));
      logEvent(`${attempt.student}: Attempt saved. Score ${attempt.score}`);
      // reset
      resetGameForStudent();
    };
    reader.readAsDataURL(state.recordingBlob);
  } else {
    pushAttempt(attempt);
    alert((state.lang==='es'?'Juego completo â€” intento guardado (sin audio).':'Game complete â€” attempt saved (no audio).'));
    logEvent(`${attempt.student}: Attempt saved (no audio). Score ${attempt.score}`);
    resetGameForStudent();
  }
}

function pushAttempt(attempt){
  const key = state.attemptsKey;
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(attempt);
  localStorage.setItem(key, JSON.stringify(arr));
  refreshAttemptsTable();
}

/* ---------- Teacher Dashboard Functions ---------- */
function refreshAttemptsTable(){
  const arr = JSON.parse(localStorage.getItem(state.attemptsKey) || '[]');
  attemptsBody.innerHTML = '';
  arr.slice().reverse().forEach((a,i)=>{ // newest first
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = a.student;
    const tdScore = document.createElement('td'); tdScore.textContent = a.score + (a.autoScore? ` (${a.autoScore}%)`: '');
    const tdLevel = document.createElement('td'); tdLevel.textContent = a.level + '/' + (a.lang||'en');
    const tdTime = document.createElement('td'); tdTime.textContent = new Date(a.timestamp).toLocaleString();
    const tdAct = document.createElement('td');
    tdAct.className = 'center';
    const playBtn = document.createElement('button'); playBtn.textContent='â–¶'; playBtn.className='secondary';
    playBtn.addEventListener('click', ()=> {
      if(a.recording){
        const w = window.open('');
        // embed audio in new window
        w.document.write(`<p>${a.student} â€” ${new Date(a.timestamp).toLocaleString()}</p>`);
        w.document.write(`<audio controls src="${a.recording}"></audio>`);
      } else {
        alert('No recording saved for this attempt.');
      }
    });
    const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this attempt?')){
        const key = state.attemptsKey;
        const arr0 = JSON.parse(localStorage.getItem(key) || '[]');
        // find index by timestamp
        const idx = arr0.findIndex(it=> it.timestamp === a.timestamp && it.student === a.student);
        if(idx>-1){ arr0.splice(idx,1); localStorage.setItem(key, JSON.stringify(arr0)); refreshAttemptsTable(); }
      }
    });
    tdAct.appendChild(playBtn); tdAct.appendChild(document.createTextNode(' ')); tdAct.appendChild(delBtn);
    tr.appendChild(tdName); tr.appendChild(tdScore); tr.appendChild(tdLevel); tr.appendChild(tdTime); tr.appendChild(tdAct);
    attemptsBody.appendChild(tr);
  });
}
refreshBtn.addEventListener('click', refreshAttemptsTable);
clearBtn.addEventListener('click', ()=>{
  if(confirm('Clear all saved attempts?')){
    localStorage.removeItem(state.attemptsKey); refreshAttemptsTable();
  }
});
exportCsvBtn.addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(state.attemptsKey) || '[]');
  if(arr.length===0){ alert('No attempts to export.'); return; }
  const rows = [['Student','Score','AutoScore','Level','Lang','Timestamp']];
  arr.forEach(a=> rows.push([a.student,a.score,a.autoScore||'',a.level,a.lang,a.timestamp]));
  const csv = rows.map(r=> r.map(cell=> `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'doctor_game_attempts.csv'; a.click();
});

/* ---------- Certificate generation (Canvas) ---------- */
certBtn.addEventListener('click', ()=>{
  const name = prompt('Enter student name for certificate:', state.studentName || '');
  if(!name) return;
  const score = prompt('Enter final score (or leave blank):', state.score||'');
  const canvas = document.createElement('canvas'); canvas.width = 1200; canvas.height = 675;
  const ctx = canvas.getContext('2d');
  // background
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width, canvas.height);
  // border
  ctx.strokeStyle = '#0366d6'; ctx.lineWidth = 12; ctx.strokeRect(20,20,canvas.width-40,canvas.height-40);
  // title
  ctx.fillStyle = '#0366d6'; ctx.font = '48px serif'; ctx.fillText('Certificate of Completion', 80,140);
  ctx.fillStyle = '#111827'; ctx.font = '28px serif'; ctx.fillText(`This certifies that`, 80,220);
  ctx.font = '40px serif'; ctx.fillText(name, 80,280);
  ctx.font = '20px serif'; ctx.fillText(`has successfully completed Doctor's Office Connect`, 80,330);
  if(score) ctx.fillText(`Score: ${score}`, 80,380);
  ctx.font = '16px serif'; ctx.fillText(`Date: ${new Date().toLocaleDateString()}`, 80,430);
  // download
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = `${name.replace(/\s+/g,'_')}_certificate.png`; a.click();
});

/* ---------- Printable confirmation slip ---------- */
slipBtn.addEventListener('click', ()=>{
  const name = state.studentName || prompt('Student name for slip:','');
  if(!name) return;
  const patient = ROUNDS[Math.max(0,state.roundIndex)].patient || '';
  const appointment = 'Thursday, 10:00 AM'; // placeholder â€” for realism we could save chosen slot
  const win = window.open('', '_blank');
  win.document.write(`<html><head><title>Confirmation Slip</title></head><body style="font-family:Arial;padding:20px">
    <h2>Appointment Confirmation</h2>
    <p><strong>Student:</strong> ${name}</p>
    <p><strong>Patient (recorded):</strong> ${patient}</p>
    <p><strong>Appointment:</strong> ${appointment}</p>
    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
    <hr/>
    <p>Bring ID and insurance (if any). If you need to reschedule, call the clinic.</p>
    <button onclick="window.print()">Print / Save as PDF</button>
  </body></html>`);
});

/* ---------- Logging ---------- */
function logEvent(msg){
  // simple console log; teacher can review attempts instead
  console.log('[DOCGAME]', msg);
}

/* initial render */
updateUI();
renderStep();

/* ---------- Accessibility: keyboard shortcuts ---------- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'r' && e.ctrlKey){ // ctrl+r = reset
    if(confirm('Reset game?')) resetGameForStudent();
  }
});
</script>
</body>
</html>
